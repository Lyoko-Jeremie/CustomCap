<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>test</title>
    <script>
        window.CAP_CUSTOM_FETCH = async (url, options) => {
            console.log("Custom fetch called for URL:", url, "with options:", options);
            if (url === "/api/challenge") {
                await window.initTestChallenge();
                console.log('(window).testChallenge.challenge', (window).testChallenge.challenge);
                return new Response(
                    JSON.stringify({
                        "challenge": (window).testChallenge.challenge,
                    }),
                    {
                        status: 200,
                        headers: {"Content-Type": "application/json"},
                    }
                );
            }
            if (url === "/api/redeem") {
                console.log("Redeem", options);
                const solutions = JSON.parse(options.body).solutions;
                const isOk = solutions === (window).testChallenge.data;
                // const isOk = false;
                return new Response(
                    JSON.stringify({
                        success: isOk,
                        token: isOk ? "1234567890abcdef" : '',
                        expires: new Date().getTime() + 1000 * 60,
                    }),
                    {
                        status: 200,
                        headers: {"Content-Type": "application/json"},
                    }
                );
            }
            return await window.fetch(url, options);
        };
    </script>
</head>
<body>

<cap-widget
        id="cap"
        data-cap-api-endpoint="/api"
        data-cap-i18n-verifying-label="正在验证..."
        data-cap-i18n-initial-state="我不是机器人"
        data-cap-i18n-solved-label="验证通过"
        data-cap-i18n-error-label="错误，请重试"
        data-cap-i18n-no-credits-link="1"
></cap-widget>

<!--data-cap-i18n-credits-link="https://www.qidian.com/"-->
<script>

    customElements.whenDefined('cap-widget').then(() => {
        const widget = document.querySelector("#cap");
        console.log(widget);
        console.log(window.CAP_CUSTOM_FETCH);

        // widget.set_CAP_CUSTOM_FETCH(window.CAP_CUSTOM_FETCH);
        widget.CAP_CUSTOM_FETCH = window.CAP_CUSTOM_FETCH;
        console.log(widget);

        widget.addEventListener("solve", function (e) {
            console.log("solve", e.detail);
            console.log("token", e.detail.token);
            console.log("usedTime", e.detail.usedTime);

            setTimeout(() => {
                widget.reset();
            }, 3000);
        });

        // widget.solve();
    });
</script>
</body>
</html>
